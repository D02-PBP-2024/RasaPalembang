{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>{{ restoran.nama }} | RasaPalembang</title>
{% endblock meta %}

{% block content %}
<main class="px-5 md:px-10 lg:px-16 xl:px-24 py-5 md:py-10 w-full mx-auto">
    <!-- Konten Restoran -->
    <div class="container mx-auto py-8 flex-grow">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">{{ restoran.nama }}</h1>
        </div>

        <!-- Detail Restoran -->
        <div class="mx-auto max-w-4xl px-4">
            <h2 class="text-2xl font-semibold mb-4">Tentang</h2>
            <div class="space-y-4 text-lg">
                <p class="flex items-center">
                    <i class="fas fa-clock mr-2"></i>
                    Jam Operasional: {{ restoran.jam_operasional }}
                </p>
                <p class="flex items-center">
                    <i class="fas fa-map-marker-alt mr-2"></i>
                    Lokasi: {{ restoran.alamat }}
                </p>
                <p class="flex items-center">
                    <i class="fas fa-phone mr-2"></i>
                    Nomor Telepon: {{ restoran.nomor_telepon }}
                </p>
                <p class="flex items-center">
                    <i class="fas fa-dollar-sign mr-2"></i>
                    Harga Rata-Rata: {{ restoran.harga_rata_rata }}
                </p>
            </div>
        </div>
    </div>

    {% if mengulas %}
    <button id="reviewButton" data-modal-target="modal" data-modal-toggle="modal" onclick="showModal();"
        class="flex justify-center items-center gap-2 w-full sm:w-max px-4 sm:px-8 py-1.5 sm:py-2 bg-[#4f9da6] hover:bg-[#3b747a] hover:shadow rounded-lg font-semibold text-white text-center max-sm:text-sm transition">
        <i class="fa-regular fa-star max-sm:scale-90"></i>
        Tulis sebuah ulasan
    </button>
    {% endif %}

    <div class="mt-12">
        <h1 class="text-4xl font-semibold">Ulasan</h1>
        <div id="ulasan"></div>
    </div>

    {% include 'restoran/detail/modal.html' %}
</main>
{% endblock %}
{% block script %}
<script>
    function setRating(rating) {
        const ratingInput = document.getElementById("id_nilai");
        ratingInput.value = rating;

        const ratingButtons = document.getElementsByClassName("ratingButton");

        for (let i = 0; i < ratingButtons.length; i++) {
            if (i < rating) {
                ratingButtons[i].classList.add("text-[#ffba00]");
                ratingButtons[i].classList.remove("text-neutral-300");
            } else {
                ratingButtons[i].classList.add("text-neutral-300");
                ratingButtons[i].classList.remove("text-[#ffba00]");
            }
        }
    }

    async function getReviews() {
        return fetch("/restoran/{{ restoran.id }}/ulasan/").then((res) => res.json())
    }

    async function refreshReviews() {
        document.getElementById("ulasan").innerHTML = "";
        document.getElementById("ulasan").className = "";
        const reviews = await getReviews();
        let htmlString = "";
        let classNameString = "";

        if (reviews.length === 0) {
            classNameString = "mt-4 flex justify-center items-center";
            htmlString = ``;
        } else {
            classNameString = "mt-5 flex flex-col justify-center gap-4"
            reviews.forEach((item) => {
                ratingHtmlString = ""
                for (let i = 0; i < 5; i++) {
                    if (i < item.nilai) {
                        ratingHtmlString += "<i class='fa-solid fa-star'></i>";
                    } else {
                        ratingHtmlString += "<i class='fa-solid fa-star text-neutral-300'></i>";
                    }
                }
                htmlString += `
                <div class="w-full border border-neutral-100 py-4 px-6 shadow-lg shadow-neutral-100 hover:shadow-neutral-200 rounded-xl transition">
                    <div class="flex gap-3 items-center">
                        <a href="/profile/${item.user.username}">
                            <img src="{% static 'images/avatar.png' %}" class="w-10 h-10 rounded-full">
                        </a>
                        <div class="flex flex-col">
                            <a href="/profile/${item.user.username}">
                                <span class="font-semibold">${item.user.nama}</span>
                            </a>
                            <span class="text-neutral-500 text-sm flex items-center gap-1">
                                <i class="fa-solid fa-coins text-neutral-500/70 text-xs"></i>
                                ${item.user.poin} poin
                            </span>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <div class="text-[#ffba00] flex md:gap-1 items-center">${ratingHtmlString}</div>
                        <span class="text-neutral-300">â€¢</span>
                        <h2>11 Januari 2024</h2>
                    </div>
                    <h3 class="mt-3">
                        ${item.deskripsi}
                    </h3>
                    <div class="mt-4">
                        ${item.user.username == "{{ user.username }}" ? "<a href='{% url 'restoran:ulasan:hapus_ulasan' restoran.id %}' class='bg-[#d04848] text-white py-2 px-4 rounded-lg text-sm font-semibold'>Hapus ulasan</a>" : ""}
                    </div>
                </div>
                `;
            });
        }
        document.getElementById("ulasan").className = classNameString;
        document.getElementById("ulasan").innerHTML = htmlString;
    }
    refreshReviews();

    function hideButton() {
        const button = document.getElementById('reviewButton');

        button.classList.add('hidden');
    }

    function showModal() {
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modalContent');

        modal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalContent.classList.add('opacity-100', 'scale-100');
        }, 50);
    }

    function hideModal() {
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modalContent');

        modalContent.classList.remove('opacity-100', 'scale-100');
        modalContent.classList.add('opacity-0', 'scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
        }, 150);
    }

    document.getElementById("cancelButton").addEventListener("click", hideModal);
    document.getElementById("closeModalButton").addEventListener("click", hideModal);

    function addReview() {
        fetch("/restoran/{{ restoran.id }}/ulasan/tambah/", {
            method: "POST",
            body: new FormData(document.querySelector('#reviewForm')),
        }).then(response => refreshReviews())

        hideButton();
        hideModal();

        return false;
    }

    document.getElementById("submitReviewForm").onclick = addReview
</script>
{% endblock %}